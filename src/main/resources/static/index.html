<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Test Interface</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .section { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        button { padding: 8px 12px; margin: 5px; cursor: pointer; }
        input, textarea { padding: 8px; margin: 5px; width: 300px; }
        #chatHistory { height: 300px; overflow-y: scroll; border: 1px solid #ccc; padding: 10px; }
        .message { margin: 5px 0; padding: 5px; background: #f5f5f5; }
    </style>
</head>
<body>
<div class="container">
    <h1>Chat Test Interface</h1>

    <div class="section">
        <h2>User Info</h2>
        <button onclick="getUserData()">Get My Info</button>
        <div id="userInfo"></div>
    </div>

    <div class="section">
        <h2>Chat Management</h2>
        <div>
            <input type="text" id="chatNameInput" placeholder="Chat name">
            <button onclick="createPublicChat()">Create Public Chat</button>
        </div>
        <div>
            <input type="text" id="userIdInput" placeholder="User ID for private chat">
            <button onclick="createPrivateChat()">Create Private Chat</button>
        </div>
        <div>
            <button onclick="getMyChats()">Get My Chats</button>
            <div id="chatsList"></div>
        </div>
    </div>

    <div class="section">
        <h2>WebSocket Chat</h2>
        <div>
            <input type="text" id="chatIdInput" placeholder="Chat ID">
            <button onclick="connectToChat()">Connect to Chat</button>
        </div>
        <div>
            <textarea id="messageInput" placeholder="Type your message"></textarea>
            <button onclick="sendMessage()">Send Message</button>
        </div>
        <div id="chatHistory"></div>
    </div>
</div>

<script>
    let stompClient = null;
    let currentChatId = null;

    // Получение данных пользователя
    function getUserData() {
        axios.get('/chat/getPersonPrincipalData')
            .then(response => {
                document.getElementById('userInfo').innerHTML =
                    `<pre>${JSON.stringify(response.data, null, 2)}</pre>`;
            })
            .catch(error => {
                console.error('Error fetching user data:', error);
            });
    }

    // Создание публичного чата
    function createPublicChat() {
        const chatName = document.getElementById('chatNameInput').value;
        axios.post(`/chat/createPublicChat/${encodeURIComponent(chatName)}`)
            .then(response => {
                alert('Public chat created: ' + JSON.stringify(response.data));
            })
            .catch(error => {
                console.error('Error creating public chat:', error);
            });
    }

    // Создание приватного чата
    function createPrivateChat() {
        const userId = document.getElementById('userIdInput').value;
        axios.post(`/chat/createPrivateChat/${userId}`)
            .then(response => {
                alert('Private chat created: ' + JSON.stringify(response.data));
            })
            .catch(error => {
                console.error('Error creating private chat:', error);
            });
    }

    // Получение списка чатов пользователя
    function getMyChats() {
        axios.get('/chat/getChats')
            .then(response => {
                document.getElementById('chatsList').innerHTML =
                    `<pre>${JSON.stringify(response.data, null, 2)}</pre>`;
            })
            .catch(error => {
                console.error('Error fetching chats:', error);
            });
    }

    function connectToChat() {
        const chatId = document.getElementById('chatIdInput').value;
        currentChatId = chatId;

        if (stompClient !== null) {
            stompClient.disconnect();
        }

        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);

        stompClient.connect({}, (frame) => {
            console.log('Connected: ' + frame);

            // Подписка на конкретный чат
            stompClient.subscribe(`/topic/chat.${chatId}`, (message) => {
                showMessage(JSON.parse(message.body));
            });

            // Отправка запроса на подключение с DTO
            const joinRequest = {
                chatId: Number(chatId)
            };
            stompClient.send("/app/chat.join", {}, JSON.stringify(joinRequest));

            // Загрузка истории с параметром chatId
            axios.get(`/chat/history?chatId=${chatId}`)
                .then(response => {
                    response.data.forEach(msg => showMessage(msg));
                    scrollChat();
                })
                .catch(handleError);
        });
    }

    // Обновленная функция отправки сообщения
    function sendMessage() {
        if (!stompClient || !currentChatId) {
            alert('Сначала подключитесь к чату');
            return;
        }

        const messageText = document.getElementById('messageInput').value.trim();
        if (!messageText) return;

        const message = {
            chatId: Number(currentChatId),
            content: messageText,
            type: 'TEXT'
        };

        stompClient.send("/app/chat.send", {}, JSON.stringify(message));
        document.getElementById('messageInput').value = '';
    }

    // Обновленное отображение сообщений
    function showMessage(message) {
        const chatHistory = document.getElementById('chatHistory');
        const messageElement = document.createElement('div');
        messageElement.className = 'message';

        messageElement.innerHTML = `
            <strong>${message.senderName || 'System'}:</strong>
            <span>${message.content}</span>
            <small>${new Date(message.sendAt).toLocaleString()}</small>
        `;

        chatHistory.appendChild(messageElement);
        scrollChat();
    }

    // Автоскролл к новым сообщениям
    function scrollChat() {
        const chatHistory = document.getElementById('chatHistory');
        chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    // Обработка ошибок
    function handleError(error) {
        console.error('Error:', error);
        if (error.response) {
            alert(`Error: ${error.response.data}`);
        } else {
            alert('Network error');
        }
    }
</script>
</body>
</html>